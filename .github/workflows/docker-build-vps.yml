name: Build Docker on VPS

# Trigger do workflow
on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch: # Permite executar manualmente

jobs:
  build-on-vps:
    name: Build and Deploy Docker Image
    runs-on: ubuntu-latest
    
    # Definir permissões mínimas necessárias para o GITHUB_TOKEN
    permissions:
      contents: read  # Para fazer checkout do código
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: Create .env file
        run: |
          cat > .env << 'ENVEOF'
          DATABASE_URL="${{ secrets.DATABASE_URL }}"
          NODE_ENV="${{ secrets.NODE_ENV || 'production' }}"
          NEXT_TELEMETRY_DISABLED="${{ secrets.NEXT_TELEMETRY_DISABLED || '1' }}"
          ENVEOF
          
          # Adicionar secrets opcionais se estiverem definidos
          if [ -n "${{ secrets.NEXTAUTH_SECRET }}" ]; then
            echo 'NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}"' >> .env
          fi
          
          if [ -n "${{ secrets.NEXTAUTH_URL }}" ]; then
            echo 'NEXTAUTH_URL="${{ secrets.NEXTAUTH_URL }}"' >> .env
          fi
          
          if [ -n "${{ secrets.API_KEY }}" ]; then
            echo 'API_KEY="${{ secrets.API_KEY }}"' >> .env
          fi
      
      - name: Build Docker Image
        run: |
          docker build -t azevedo-site:${{ github.sha }} -t azevedo-site:latest .
      
      - name: Save and Transfer Docker Image
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          REGISTRY_HOST: ${{ secrets.REGISTRY_HOST || secrets.VPS_HOST }}
          REGISTRY_PORT: ${{ secrets.REGISTRY_PORT || '5000' }}
        run: |
          # Criar tarball da imagem
          docker save azevedo-site:latest | gzip > azevedo-site.tar.gz
          
          # Transferir imagem e .env para o VPS
          scp -i ~/.ssh/id_rsa azevedo-site.tar.gz $VPS_USER@$VPS_HOST:/tmp/
          scp -i ~/.ssh/id_rsa .env $VPS_USER@$VPS_HOST:/tmp/
      
      - name: Deploy on VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PATH: ${{ secrets.VPS_PATH }}
          REGISTRY_HOST: ${{ secrets.REGISTRY_HOST || secrets.VPS_HOST }}
          REGISTRY_PORT: ${{ secrets.REGISTRY_PORT || '5000' }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          ssh -i ~/.ssh/id_rsa $VPS_USER@$VPS_HOST "bash -s" << EOF
            set -e
            
            # Navegar para o diretório do projeto
            cd "$VPS_PATH"
            
            # Carregar a imagem do tarball
            echo "Loading Docker image..."
            docker load < /tmp/azevedo-site.tar.gz
            
            # Taguear para o registry local
            REGISTRY="$REGISTRY_HOST:$REGISTRY_PORT"
            docker tag azevedo-site:latest \$REGISTRY/azevedo-site:latest
            docker tag azevedo-site:latest \$REGISTRY/azevedo-site:$COMMIT_SHA
            
            # Configurar registry como insecure (HTTP) se necessário
            REGISTRY_ENTRY="\"$REGISTRY_HOST:$REGISTRY_PORT\""
            if ! grep -q "$REGISTRY_ENTRY" /etc/docker/daemon.json 2>/dev/null; then
              echo "Configuring Docker to allow insecure registry $REGISTRY_HOST:$REGISTRY_PORT..."
              
              # Criar ou atualizar daemon.json
              if [ -f /etc/docker/daemon.json ]; then
                # Arquivo existe, adicionar ao array de insecure-registries
                sudo cp /etc/docker/daemon.json /etc/docker/daemon.json.bak
                if grep -q "insecure-registries" /etc/docker/daemon.json; then
                  # Adicionar ao array existente
                  sudo sed -i "s/\"insecure-registries\": \[/\"insecure-registries\": [$REGISTRY_ENTRY, /" /etc/docker/daemon.json
                else
                  # Adicionar nova chave insecure-registries
                  sudo sed -i "s/{/{\"insecure-registries\": [$REGISTRY_ENTRY],/" /etc/docker/daemon.json
                fi
              else
                # Criar novo arquivo
                sudo mkdir -p /etc/docker
                echo "{\"insecure-registries\": [$REGISTRY_ENTRY]}" | sudo tee /etc/docker/daemon.json > /dev/null
              fi
              
              # Reiniciar Docker apenas se configuração mudou
              sudo systemctl restart docker || sudo service docker restart
              echo "Waiting for Docker to restart..."
              sleep 5
            fi
            
            # Push para o registry
            echo "Pushing to registry \$REGISTRY..."
            docker push \$REGISTRY/azevedo-site:latest
            docker push \$REGISTRY/azevedo-site:$COMMIT_SHA
            
            # Mover .env para o diretório do projeto
            mv /tmp/.env .env
            
            # Parar e remover container antigo
            docker stop azevedo-site-container || true
            docker rm azevedo-site-container || true
            
            # Pull da imagem do registry e executar novo container
            docker pull \$REGISTRY/azevedo-site:latest
            docker run -d \
              --name azevedo-site-container \
              -p 3000:3000 \
              --env-file .env \
              --restart unless-stopped \
              \$REGISTRY/azevedo-site:latest
            
            # Executar migrations do Prisma
            echo "Running Prisma migrations..."
            if docker exec azevedo-site-container npx prisma migrate deploy; then
              echo "✓ Migrations completed successfully"
            else
              echo "⚠ Warning: Migrations failed or no migrations to run"
            fi
            
            # Limpar arquivos temporários e imagens antigas
            rm -f /tmp/azevedo-site.tar.gz /tmp/.env
            docker image prune -f
          EOF
      
      - name: Verify Deployment
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh -i ~/.ssh/id_rsa $VPS_USER@$VPS_HOST "docker ps | grep azevedo-site-container"
      
      - name: Cleanup SSH
        if: always()
        run: |
          rm -rf ~/.ssh/id_rsa
