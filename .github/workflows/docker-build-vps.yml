name: Build Docker on VPS

# Trigger do workflow
on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch: # Permite executar manualmente

jobs:
  build-on-vps:
    name: Build Docker Image on VPS
    runs-on: ubuntu-latest
    
    # Definir permissões mínimas necessárias para o GITHUB_TOKEN
    permissions:
      contents: read  # Para fazer checkout do código
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy and Build on VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PATH: ${{ secrets.VPS_PATH }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: ${{ secrets.NODE_ENV || 'production' }}
          NEXT_TELEMETRY_DISABLED: ${{ secrets.NEXT_TELEMETRY_DISABLED || '1' }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          ssh -i ~/.ssh/id_rsa $VPS_USER@$VPS_HOST << 'EOF'
            set -e
            
            # Navegar para o diretório do projeto no VPS
            cd ${{ secrets.VPS_PATH }}
            
            # Fazer pull das últimas mudanças
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master
            
            # Criar arquivo .env a partir dos secrets do GitHub
            echo "Creating .env file from GitHub secrets..."
            cat > .env << 'ENVEOF'
          DATABASE_URL="${{ secrets.DATABASE_URL }}"
          NODE_ENV="${{ secrets.NODE_ENV || 'production' }}"
          NEXT_TELEMETRY_DISABLED="${{ secrets.NEXT_TELEMETRY_DISABLED || '1' }}"
          ENVEOF
            
            # Adicionar secrets opcionais se estiverem definidos
            if [ -n "${{ secrets.NEXTAUTH_SECRET }}" ]; then
              echo 'NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}"' >> .env
            fi
            
            if [ -n "${{ secrets.NEXTAUTH_URL }}" ]; then
              echo 'NEXTAUTH_URL="${{ secrets.NEXTAUTH_URL }}"' >> .env
            fi
            
            if [ -n "${{ secrets.API_KEY }}" ]; then
              echo 'API_KEY="${{ secrets.API_KEY }}"' >> .env
            fi
            
            echo "✓ .env file created successfully"
            
            # Build da imagem Docker
            docker build -t azevedo-site:latest .
            
            # Opcional: Parar e remover container antigo
            docker stop azevedo-site-container || true
            docker rm azevedo-site-container || true
            
            # Executar novo container usando --env-file
            docker run -d \
              --name azevedo-site-container \
              -p 3000:3000 \
              --env-file .env \
              --restart unless-stopped \
              azevedo-site:latest
            
            # Executar migrations do Prisma (se necessário)
            echo "Running Prisma migrations..."
            if docker exec azevedo-site-container npx prisma migrate deploy; then
              echo "✓ Migrations completed successfully"
            else
              echo "⚠ Warning: Migrations failed or no migrations to run"
            fi
            
            # Limpar imagens antigas não utilizadas
            docker image prune -f
          EOF
      
      - name: Verify Deployment
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh -i ~/.ssh/id_rsa $VPS_USER@$VPS_HOST << 'EOF'
            docker ps | grep azevedo-site-container
          EOF
      
      - name: Cleanup SSH
        if: always()
        run: |
          rm -rf ~/.ssh/id_rsa
